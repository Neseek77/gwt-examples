#summary More notes on how to connect to mysql database

=Table of Contents= 
<wiki:toc max_depth="2" />

= Demo =
 Sample an application using MySql on Apache Tomcat server. 

== MySql Conn Demo == 
 * [http://gonevertical.org/DemoMySqlConn/ MySql Conn Application] - New Demo using GWT 2.03+ 
 * [http://code.google.com/p/gwt-examples/source/browse/#svn/trunk/DemoMySqlConn/src/org/gonevertical/demo/client Source] - See the code

== FeedBack MySql Conn Demo ==
 * [http://gonevertical.org/DemoFeedback/ Feedback Application Demo] 
 * [http://code.google.com/p/gwt-examples/source/browse/#svn/trunk/DemoFeedback/src/org/gonevertical/demo/client/feedback Source]

= JDBC Connector =
 * Add a JDBC connector jar to your Build Path
 * I put it here. My Projects are configured like: /opt/gwt-linux/mysql-connector-java-5.0.8-bin.jar
 * Check your Eclipse referenced libraries for jar
 * Example Eclipse Project Source code of Mysql Conn - http://gwt-examples.googlecode.com/svn/trunk/gwt-test-MySQLConn/src/com/tribling/gwt/test/mysqlconn/server/
 == Links ==
 * JDBC Connector - http://www.mysql.com/products/connector/j/ - download MySQL Connector/J 5.1
 * Example MySQL Database, The King James Bible [http://sourceforge.net/project/showfiles.php?group_id=186532&package_id=249676&release_id=548680 Download Bible Database Here] (It comes as a MySQL Dump)

= Tomcat Setup =
 When you use tomcat, the servlet container has to be given access outside of its container. More info here: [gwtTomcat].

 * Fix this problem: java.security.AccessControlException access denied (java.net.SocketPermission localhost resolve)
 * More information on this here: [gwtTomcat]
 You will need to change Tomcat configuration.
{{{
#for debian/ubuntu
# I added to /etc/tomcat5.5/policy.d/04webapps.policy
# Or make your own /etc/tomcat5.5/policy.d/myGWTPolicys.policy
# you can also change file to: file:/apps/directory/yourGWTTomcatApps/- 
grant codeBase "file:${catalina.home}/webapps/-" {
      permission java.net.SocketPermission "192.168.12.81:3306", "connect";
};
}}} 


= Code Snippets =

 == MySQL Connection ==
 Connect to db. Don't forget to change the parameters.
{{{
/**
 * db conn
 * 
 * Make sure you add a reference library (external jar in build path) JDBC Connector - 
 * You will see I put it in /opt/gwt-linux/mysql-connector-java-5.0.8-bin.jar
 * 
 * @return Connection
 */
private Connection getConn() {

  	    Connection conn	= null;
	    String url 		= "jdbc:mysql://192.168.12.81:3306/";
	    String db 		= "hostdb";
	    String driver 	= "com.mysql.jdbc.Driver";
	    String user 	= "";
	    String pass 	= "";
		
        try {
                Class.forName(driver).newInstance();
        } catch (InstantiationException e) {
                e.printStackTrace();
        } catch (IllegalAccessException e) {
                e.printStackTrace();
        } catch (ClassNotFoundException e) {
                e.printStackTrace();
        }
        try {
        		
        		conn = DriverManager.getConnection(url+db, user, pass);
        } catch (SQLException e) {
        		System.err.println("Mysql Connection Error: ");
                e.printStackTrace();
        }
		return conn;
}
}}}

 == Get Row Count ==
 Use this to size an array for your values
{{{
/*
 * get row count
 */
protected static int getResultSetSize(ResultSet resultSet) {
    int size = -1;

    try {
        resultSet.last();
        size = resultSet.getRow();
        resultSet.beforeFirst();
    } catch(SQLException e) {
        return size;
    }

    return size;
}
}}}

 == Query ==
 Query statement, using connection, statement, resultset, and get record. Setup a connection first.
{{{
String query = "SELECT * FROM table";
 
try {
    Connection conn = this.getConn();
    Statement select = conn.createStatement();
    ResultSet result = select.executeQuery(query);
    while (result.next()) {
    	String s = result.getString(1);
    }
    select.close();
    result.close();
    conn.close();
} catch(SQLException e) {
	System.err.println("Mysql Statement Error: " + query);
	e.printStackTrace();
}
}}}

 == Update / Insert ==
 Update and Insert into database, MySql or MsSql or whatever database you have. Setup a connection first
{{{
//save session data to table 
String query = "INSERT INTO `session` (UserID, SessionID, LastAccessed, DateCreated) " +
			   "VALUES ('" + this.dbUserID + "', '" + this.SessionID + "' , UNIX_TIMESTAMP(), UNIX_TIMESTAMP());";

try {
    Connection conn = this.getConn();
    Statement update = conn.createStatement();
    update.executeUpdate(query);
    
    //get last id 
    ResultSet result = update.getGeneratedKeys(); 
    if (result != null && result.next()) { 
        int rsId = result.getInt(1);  
    }

    result.close();
    update.close();
    conn.close();
} catch(SQLException e) {
    System.err.println("Mysql Statement Error: " + query);
    e.printStackTrace();
}
}}}


 == Escape String For SQL ==
 Apache has some cool functions for escaping strings. This can only be run on server side, preparing the sql data for insert. You don't have to unescape b/c it comes out as is. It just allows you to save with "'" '"' in the string.
 * Right Click Project > Build Path > Configure Build Path > Libraries > Add External Jar
 * Link to Apache jar documentation: [http://commons.apache.org/lang/api-release/index.html?org/apache/commons/lang/StringEscapeUtils.html Classes Documentation]
 * Download Jar: [http://commons.apache.org/lang/ Goto Download]
{{{
import org.apache.commons.lang.StringEscapeUtils;

/**
 * escape string to db
 * @param s
 * @return
 */
protected static String escapeForSql(String s) {

	String rtn = StringEscapeUtils.escapeSql(s);
	
	return rtn;
}
}}}

 Improved Escape method for fixing data before its stuck into db
{{{
/**
 * escape string to db
 * 
 * remove harmfull db content
 * remove harmfull tags
 *
 * @param s
 * @return
 */
protected static String escapeForSql(String s) {
	
	//remove harmful HTML tags
	if (s != null) {
		s = s.replaceAll("(?i)</?(HTML|SCRIPT|HEAD|CSS)\\b[^>]*>", "");	
	}

	String rtn = StringEscapeUtils.escapeSql(s);
	
	//escape utils returns null if null
	if (rtn == null) {
		rtn = "";
	}

	return rtn;
}
}}}

= Trasporting Data / Recordsets Around =
 This is an example of how I transport data from server to client and back. This is my favorite way and by far the most efficient and easiest way to do it.

 I use a class like this to store MySQL record set data into an object array. This makes it very easy to pass around data. Now if you use private methods and/or fields in the class that goes from server to client, you will have have to change Tomcat security. See more in [gwtTomcat].
{{{
/**
 * I use this class to store my mysql recordset in an object that is an array.
 * This will give an example of how I pass data from the server to client in an object, 
 * one of my favorites for its simplicity.
 * 
 * @author branflake2267
 *
 */
public class BibleData implements IsSerializable {

	// fields to store data
	public String book;
	public int howManyChapters;
	public int howManyVerses;
	
	/**
	 * constructor
	 */
	public BibleData() {
		// nothing to do when transporting
	}
	
}
}}}

 This is an example of how I spool the data into the Object Array from MySQL.
{{{
public BibleData[] getBibleInfo() {
	
	String query = "SELECT bid, en FROM book;";
	
	// prepare for rpc transport
	BibleData[] bibleData = null;
	
    try {
    	Connection connection = getConn();
        Statement select = connection.createStatement();
        ResultSet result = select.executeQuery(query);
       
        // init object into the size we need, like a recordset
        int rsSize = getResultSetSize(result); //size the array
        bibleData = new BibleData[rsSize];
        
        int i = 0;
        while (result.next()) {
        	
        	// init each object in the array !!!!
        	bibleData[i] = new BibleData(); // <-THIS IS CRITICAL TO REMEMBER!!!! init each array with the object type (I forget to do this so often)
        	
        	int bid = result.getInt(1);
        	bibleData[i].book = result.getString(2);
        	bibleData[i].howManyChapters = getHowManyChapters(bid);
        	bibleData[i].howManyVerses = getHowManyVerses(bid);
        	
            i++;
        }
        
        // clean up
        result.close();
        connection.close();
        
    } catch(Exception e) {
    	
    	System.err.println("Mysql Statement Error: " + query);
    	e.printStackTrace();
    	
    }
	
    // return the array
    return bibleData;
}
}}}

= Feed Back Widget =
The feedback widget in the repository gathers up the inputs and sends them to the server and inserts them into MySql. 

 * [http://gonevertical.org/DemoFeedback/ Feedback Application Demo] 
 * [http://code.google.com/p/gwt-examples/source/browse/#svn/trunk/DemoFeedback/src/org/gonevertical/demo/client/feedback Source]

 My Feedback Table
{{{
CREATE TABLE `gwt_feedback` (
  `ID` int(11) NOT NULL AUTO_INCREMENT,
  `UserID` int(11) DEFAULT '0',
  `FromEmail` varchar(150) DEFAULT NULL,
  `FromName` varchar(150) DEFAULT NULL,
  `Subject` varchar(250) DEFAULT NULL,
  `Message` text,
  `Suggestion` tinyint(1) DEFAULT '0',
  `Comment` tinyint(1) DEFAULT '0',
  `Problem` tinyint(1) DEFAULT '0',
  `Other` tinyint(1) DEFAULT '0',
  `Post` tinyint(1) DEFAULT NULL,
  `DateCreated` datetime DEFAULT NULL,
  `LastUpdated` datetime DEFAULT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=MyISAM 
}}}