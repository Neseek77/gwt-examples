#summary test out wiki stuff

{{{
Brandon Donnelson
http://gwt-examples.googlecode.com
http://c.gawkat.com
Challenge is to: Spice up the java forum with some profile pictures, lets beat the python community. :)
}}}


{{{
  private boolean doSomeExist() {
    DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();
    Query q = new Query("BlobTmpJdo");
    PreparedQuery pq = datastore.prepare(q);
    long l = pq.countEntities(FetchOptions.Builder.withLimit(1));
    boolean b = false;
    if (l > 0) {
      b = true;
    }
    return b;
  }

  private boolean doSomeExist() {
    PersistenceManager pm = sp.getPersistenceManager();
    boolean b = false;
    try {
      javax.jdo.Query q = pm.newQuery("select id from " + BlobTmpJdo.class.getName());
      List<String> ids = (List<String>) q.execute();
      Iterator<String> itr = ids.iterator();
      while(itr.hasNext()) {
        b = true;
        break;
      }
      q.closeAll();
    } catch (Exception e) { 
      e.printStackTrace();
      log.log(Level.SEVERE, "", e);
    } finally {
      pm.close();
    }
    return b;
  }
}}}

{{{
  private void close() {
    try {
      writeChannel.closeFinally();
    } catch (IllegalStateException e) {
      success = false;
      log.severe("close(): Error 6: writeChannel.closeFinally() error " + e.toString());
    } catch (IOException e) {
      success = false;
      log.severe("close(): Error 7: writeChannel.closeFinally() error " + e.toString());
    }
    
    if (success == false) {
      log.severe("close(): Error 8: quitting...");
      return;
    }
    
    BlobKey blobKey = fileService.getBlobKey(file);
    
    // try by finding filename
    if (blobKey == null) {
      log.severe("close(): Blobkey was null. 1. trying workaround.");
      blobKey = tryfindingBlobKey();
    }
    
    // try waiting then check fileservice again
    if (blobKey == null) {
      log.info("close(): 2. trying to get it from fileservice again.");
      try {
        wait(2000);
      } catch (InterruptedException e) {
        log.warning("close(): 3. couldn't wait 2 seconds.");
        e.printStackTrace();
      }
      blobKey = fileService.getBlobKey(file);
    }
    
    // try finding the filename again
    if (blobKey == null) {
      log.severe("close(): 4. Blobkey was null. trying workaround.");
      blobKey = tryfindingBlobKey();
    }
    
    // quit if haven't found it
    if (blobKey == null) {
      success = false;
      log.severe("close(): 5. Workaround, Blobkey was null agian. Couldn't find the blobkey using the filename");
      return;
    }
  }

  private BlobKey tryfindingBlobKey() {
    log.info("tryfindingBlobKey(): filename=" + filename);
    
    String skey = null;
    DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();
    try {
      Query q = new Query("__BlobInfo__");
      q.addFilter("filename", FilterOperator.EQUAL, filename);
      PreparedQuery e = datastore.prepare(q);
      Iterator<Entity> itr = e.asIterator();
      while (itr.hasNext()) {
        Entity entity = itr.next();
        Key k = entity.getKey(); 
        // #GAE needs a k.getStringId(); // only has k.getId();
        String sk = k.toString();
        String sbk = sk.replaceFirst(".*?\"", "");
        sbk = sbk.replaceFirst("\".*", "");
        skey = sbk;
      }
    } catch (Exception e) {
      success = false;
      log.log(Level.SEVERE, "decode(): ERROR: ", e);
    } 
    
    BlobKey blobKey = null;
    if (skey != null) {
      blobKey = new BlobKey(skey);
    } else {
      log.warning("tryfindingBlobKey(): warn: wasn't able to parse the blobkey or find the file: skey=" + skey);
    }
    
    return blobKey;
  }
}}}


{{{
    Icon icon = Icon.getDefaultIcon();
    
    Point anchor = Point.newInstance(16, 0); 
    icon.setInfoWindowAnchor(anchor);
    
    MarkerOptions options = MarkerOptions.newInstance(icon);
    options.setBouncy(true);
    options.setAutoPan(true);
    options.setDraggable(draggable);
    options.setTitle(mapItemData.getName());
    
    LatLng position = LatLng.newInstance(lat, lng);
    marker = new Marker(position, options);
    map.addOverlay(marker);
    
    marker.addMarkerDragEndHandler(new MarkerDragEndHandler() {
      public void onDragEnd(MarkerDragEndEvent event) {
        setPosition();
      }
    });
}}}